<div class="notification is-info" style="margin-top: 30px;">
    <i class="fas fa-snowplow"></i>&nbsp;&nbsp;Support for DICOMweb is experimental at this time.
</div>                        

<div class="field" style="margin-top: 30px;">
    <label class="label">URL</label>
    <div class="control">
        <input name="url" class="input" required='true' autocomplete='off' type="text"
            placeholder="URL" value="{{targets[edittarget].url}}"
            size="15">
    </div>
</div>

<!-- Authentication Method Selection -->
<h1 class="title is-4" style="margin-top: 40px;">Authentication</h1>

<div class="field">
    <label class="label">Authentication Method</label>
    <div class="control">
        <div class="select">
            <select id="auth_method_select" name="auth_method">
                <option value="none" {% if not targets[edittarget].access_token and not targets[edittarget].http_user and not targets[edittarget].gcp_service_account_json_path %}selected{% endif %}>None</option>
                <option value="token" {% if targets[edittarget].access_token %}selected{% endif %}>Bearer Token</option>
                <option value="basic" {% if targets[edittarget].http_user %}selected{% endif %}>HTTP Basic Auth</option>
                <option value="gcp_service_account" {% if targets[edittarget].gcp_service_account_json_path %}selected{% endif %}>GCP Service Account</option>
            </select>
        </div>
    </div>
    <p class="help">Select the authentication method for your DICOMweb endpoint</p>
</div>

<!-- HTTP Basic Auth Section (initially hidden) -->
<div id="basic_auth_section" style="display: none; margin-top: 20px;">
    <div class="field">
        <label class="label">Username</label>
        <div class="control">
            <input name="http_user" id="http_user" class="input" autocomplete='off' placeholder="HTTPS username"
               value="{{targets[edittarget].http_user if targets[edittarget].http_user else ''}}">
        </div>
    </div>
    <div class="field">
        <label class="label">Password</label>
        <div class="control">
            <input name="http_password" id="http_password" type="password" class="input" autocomplete='off' placeholder="HTTPS password"
               value="{{targets[edittarget].http_password if targets[edittarget].http_password else ''}}">
        </div>
    </div>
</div>

<!-- Bearer Token Section (initially hidden) -->
<div id="token_auth_section" style="display: none; margin-top: 20px;">
    <div class="field">
        <label class="label">Access Token</label>
        <div class="control">
            <input name="access_token" id="access_token" class="input" autocomplete='off' placeholder="Bearer token"
               value="{{targets[edittarget].access_token if targets[edittarget].access_token else ''}}">
        </div>
        <p class="help">Provide your OAuth 2.0 access token or API key</p>
    </div>
</div>

<!-- GCP Service Account Section (initially hidden) -->
<div id="gcp_auth_section" style="display: none; margin-top: 20px;">
    <div class="notification is-warning">
        <strong>GCP Service Account Authentication</strong><br>
        Upload your Google Cloud service account JSON key file. The file will be securely stored in <code>/opt/mercure/config/gcp-keys/</code>.
    </div>
    
    <div class="field">
        <label class="label">Service Account JSON Key</label>
        <div class="control">
            <div class="file has-name is-fullwidth">
                <label class="file-label">
                    <input class="file-input" type="file" id="gcp_json_file" name="gcp_json_file" accept=".json">
                    <span class="file-cta">
                        <span class="file-icon">
                            <i class="fas fa-upload"></i>
                        </span>
                        <span class="file-label">
                            Choose a fileâ€¦
                        </span>
                    </span>
                    <span class="file-name" id="gcp_file_name">
                        {% if targets[edittarget].gcp_service_account_json_path %}
                            {{ targets[edittarget].gcp_service_account_json_path.split('/')[-1] }}
                        {% else %}
                            No file selected
                        {% endif %}
                    </span>
                </label>
            </div>
        </div>
        <p class="help">Upload your service account JSON key file from Google Cloud Console</p>
    </div>

    <!-- Hidden field to store the path after upload -->
    <input type="hidden" name="gcp_service_account_json_path" id="gcp_service_account_json_path" 
           value="{{targets[edittarget].gcp_service_account_json_path if targets[edittarget].gcp_service_account_json_path else ''}}">

    <div class="field">
        <label class="label">OAuth Scopes (Optional)</label>
        <div class="control">
            <input name="gcp_auth_scopes" id="gcp_auth_scopes" class="input" autocomplete='off' 
                   placeholder="https://www.googleapis.com/auth/cloud-healthcare"
                   value="{% if targets[edittarget].gcp_auth_scopes %}{{ ','.join(targets[edittarget].gcp_auth_scopes) }}{% endif %}">
        </div>
        <p class="help">Comma-separated OAuth scopes. Leave empty to use default Cloud Healthcare API scope.</p>
    </div>

    <div class="field" id="upload_status_field" style="display: none;">
        <div class="notification" id="upload_status">
        </div>
    </div>
</div>

<h1 class="title is-4" style="margin-top: 40px;">Custom URL Prefixes</h1>

<div class="field">
    <label class="label">QIDO-RS</label>
    <div class="control">
        <input name="qido_url_prefix" class="input" autocomplete='off' placeholder="QIDO-RS URL"
           value="{{targets[edittarget].qido_url_prefix if targets[edittarget].qido_url_prefix else ''}}">
    </div>
</div>
<div class="field">
    <label class="label">WADO-RS</label>
    <div class="control">
        <input name="wado_url_prefix" class="input" autocomplete='off' placeholder="WADO-RS URL"
           value="{{targets[edittarget].wado_url_prefix if targets[edittarget].wado_url_prefix else ''}}">
    </div>
</div>
<div class="field">
    <label class="label">STOW</label>
    <div class="control">
        <input name="stow_url_prefix" class="input" autocomplete='off' placeholder="STOW URL"
           value="{{targets[edittarget].stow_url_prefix if targets[edittarget].stow_url_prefix else ''}}">
    </div>
</div>

<script nonce="{{ csp_nonce }}">
// Authentication method toggle logic
$(document).ready(function() {
    const authSelect = $('#auth_method_select');
    const basicSection = $('#basic_auth_section');
    const tokenSection = $('#token_auth_section');
    const gcpSection = $('#gcp_auth_section');
    
    function updateAuthSections() {
        const selectedMethod = authSelect.val();
        
        console.log('Auth method selected:', selectedMethod); // Debug log
        
        // Hide ALL sections first
        basicSection.hide();
        tokenSection.hide();
        gcpSection.hide();
        
        // Clear fields in hidden sections (optional - helps with form submission)
        basicSection.find('input').val('');
        tokenSection.find('input').val('');
        // Don't clear GCP fields as we want to preserve the path if switching away temporarily
        
        // Show only the selected section
        if (selectedMethod === 'basic') {
            basicSection.show();
            console.log('Showing HTTP Basic Auth section');
        } else if (selectedMethod === 'token') {
            tokenSection.show();
            console.log('Showing Bearer Token section');
        } else if (selectedMethod === 'gcp_service_account') {
            gcpSection.show();
            console.log('Showing GCP Service Account section');
        } else if (selectedMethod === 'none') {
            // Nothing to show - all sections remain hidden
            console.log('No authentication selected');
        }
    }
    
    // Initialize on page load - show correct section based on current value
    updateAuthSections();
    
    // Update on selection change
    authSelect.on('change', function() {
        updateAuthSections();
    });
    
    // File upload display - update filename when file selected
    const fileInput = $('#gcp_json_file');
    const fileName = $('#gcp_file_name');
    
    fileInput.on('change', function() {
        if (this.files && this.files[0]) {
            fileName.text(this.files[0].name);
            console.log('File selected:', this.files[0].name);
        } else {
            fileName.text('No file selected');
        }
    });
});

// Handle file upload before form submission
$(document).ready(function() {
    $('form').on('submit', async function(e) {
        const authMethod = $('#auth_method_select').val();
        const fileInput = document.getElementById('gcp_json_file');
        const uploadStatus = $('#upload_status');
        const uploadStatusField = $('#upload_status_field');
        const pathInput = $('#gcp_service_account_json_path');
        
        console.log('Form submitting with auth method:', authMethod);
        
        // Only handle GCP service account uploads if a NEW file was selected
        if (authMethod === 'gcp_service_account' && fileInput && fileInput.files.length > 0) {
            e.preventDefault();
            console.log('Uploading GCP service account key...');
            
            // Show upload in progress
            uploadStatusField.show();
            uploadStatus.removeClass().addClass('notification is-info');
            uploadStatus.text('Uploading service account key...');
            
            const formData = new FormData();
            formData.append('gcp_json_file', fileInput.files[0]);
            formData.append('target_name', '{{edittarget}}');
            
            try {
                const response = await fetch('/targets/upload_gcp_key', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                console.log('Upload response:', result);
                
                if (response.ok && result.success) {
                    uploadStatus.removeClass().addClass('notification is-success');
                    uploadStatus.text('File uploaded successfully!');
                    
                    // Set the path in hidden field
                    pathInput.val(result.file_path);
                    console.log('File path set to:', result.file_path);
                    
                    // Submit the form after successful upload
                    setTimeout(() => {
                        console.log('Submitting form...');
                        e.target.submit();
                    }, 1000);
                } else {
                    uploadStatus.removeClass().addClass('notification is-danger');
                    uploadStatus.text('Error: ' + (result.error || 'Upload failed'));
                    console.error('Upload failed:', result);
                }
            } catch (error) {
                uploadStatus.removeClass().addClass('notification is-danger');
                uploadStatus.text('Error uploading file: ' + error.message);
                console.error('Upload error:', error);
            }
        } else if (authMethod === 'gcp_service_account' && (!fileInput || fileInput.files.length === 0)) {
            // GCP auth selected but no new file - check if path already exists
            if (!pathInput.val()) {
                e.preventDefault();
                alert('Please select a service account JSON file to upload.');
                return false;
            }
            // If path exists, allow normal form submission
            console.log('Using existing GCP key at:', pathInput.val());
        }
    });
});
</script>